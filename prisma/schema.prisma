generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
  MODERATOR
}

model User {
  id                Int                   @id @default(autoincrement())
  name              String
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  email             String                @unique
  hash              String?     
  hashedRt          String?
  role              Role[]                @default([USER])
  accounts          Account[]
  problems          Problem[]            @relation("ProblemCreator")
  submissions   Submission[]
  @@map("users")
}

model Account {
  id                Int       @id @default(autoincrement())
  userId            Int
  provider          String    // "google", "github", "discord", etc.
  providerAccountId String    // The user's ID from the OAuth provider
  accessToken       String?   @db.Text
  refreshToken      String?   @db.Text
  expiresAt         DateTime?
  tokenType         String?
  scope             String?
  idToken           String?   @db.Text
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId]) // Prevent duplicate provider accounts
  @@map("accounts")
}

model Problem {
  id                  Int                   @id @default(autoincrement())
  title               String   
  slug                String                @unique()
  description         String
  difficulty          String
  created_at          DateTime              @default(now())
  // for S3
  test_case_prefix    String?    

  //for local storage
  tests_dir_ref             String?    //like: tests/{slug}/

  created_by          Int?        
  creator             User?                @relation("ProblemCreator", fields: [created_by], references: [id])
  submissions         Submission[]
}

model Submission {
  id                        Int           @id @default(autoincrement())
  problem_id                Int
  user_id                   Int
  language                  String
  source_code               String
  verdicate                 String        @default("PENDING")
  execution_time            Float?
  memory_user               Int?
  created_at                DateTime      @default(now())

  user                      User          @relation(fields: [user_id], references: [id])
  problem        Problem     @relation(fields: [problem_id], references: [id])
  results       SubmissionResult[]
}

model SubmissionResult {
  id             Int          @id @default(autoincrement())
  submission     Submission   @relation(fields: [submissionId], references: [id])
  submissionId   Int
  testcaseName   String        // e.g. "input_1.txt"
  verdict        String        // e.g. ACCEPTED, WRONG_ANSWER, TLE
  executionTime  Float?
  memoryUsed     Int?
  createdAt      DateTime      @default(now())
}